{% extends "base.html" %}

{% block title %}Fight #{{ fight.id }} - WvW Analytics{% endblock %}

{% block content %}
<div class="mb-32">
    <a href="/analyze" class="inline-flex items-center gap-8 text-sm text-text-muted hover:text-text-main mb-16">
        <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Analyze
    </a>
    <h1 class="text-xl font-bold text-gw2-gold mb-8">Fight #{{ fight.id }}</h1>
    <p class="text-sm text-text-muted">{{ fight.evtc_filename }}</p>
</div>

<div class="grid grid-cols-2 md:grid-cols-6 gap-16 mb-32">
    <div class="bg-surface-elevated border border-border-subtle rounded p-16">
        <div class="text-xs text-text-muted mb-8">Duration</div>
        <div class="text-base font-bold text-text-main font-tabular">
            {% if fight.duration_ms %}
                {% set minutes = (fight.duration_ms // 60000) %}
                {% set seconds = ((fight.duration_ms % 60000) // 1000) %}
                {{ minutes }}:{{ '%02d' % seconds }}
            {% else %}
                Unknown
            {% endif %}
        </div>
    </div>
    <div class="bg-surface-elevated border border-border-subtle rounded p-16">
        <div class="text-xs text-text-muted mb-8">Context</div>
        <div class="text-base font-bold text-text-main">
            {{ fight.context.value.replace('_', ' ').title() }}
        </div>
    </div>
    <div class="bg-surface-elevated border border-border-subtle rounded p-16">
        <div class="text-xs text-text-muted mb-8">Result</div>
        <div class="text-base font-bold">
            {% if fight.result.value == 'victory' %}
            <span class="text-status-success">Victory</span>
            {% elif fight.result.value == 'defeat' %}
            <span class="text-status-error">Defeat</span>
            {% elif fight.result.value == 'draw' %}
            <span class="text-status-warning">Draw</span>
            {% else %}
            <span class="text-text-muted">Unknown</span>
            {% endif %}
        </div>
    </div>
    <div class="bg-surface-elevated border border-border-subtle rounded p-16">
        <div class="text-xs text-text-muted mb-8">Allied Players</div>
        <div class="text-base font-bold text-status-success font-tabular">{{ fight.ally_count }}</div>
    </div>
    <div class="bg-surface-elevated border border-border-subtle rounded p-16">
        <div class="text-xs text-text-muted mb-8">Enemy Players</div>
        <div class="text-base font-bold text-status-error font-tabular">{{ fight.enemy_count }}</div>
    </div>
    <div class="bg-surface-elevated border border-border-subtle rounded p-16">
        <div class="text-xs text-text-muted mb-8">Map ID</div>
        <div class="text-base font-bold text-text-main font-tabular">
            {{ fight.map_id if fight.map_id else 'Unknown' }}
        </div>
    </div>
</div>

{% if squad_boon_uptimes %}
<div class="bg-surface-elevated border border-border-subtle rounded overflow-hidden mb-32">
    <div class="p-24 border-b border-border-subtle flex flex-col gap-12 md:flex-row md:items-center md:justify-between">
        <div>
            <h2 class="text-lg font-bold text-text-main">Squad Boon Uptimes</h2>
            <p class="text-sm text-text-muted">Average uptime per subgroup (allies only)</p>
        </div>
        <div class="flex items-center gap-12">
            <span class="text-sm text-text-muted">Detailed boon generation</span>
            <a href="{{ boon_toggle_off_url if show_boon_columns else boon_toggle_on_url }}"
               class="inline-flex items-center gap-8 px-16 py-8 rounded border transition-colors
                      {% if show_boon_columns %}
                          border-status-success text-status-success bg-status-success/10
                      {% else %}
                          border-border-subtle text-text-muted hover:text-text-main
                      {% endif %}">
                {% if show_boon_columns %}
                <span>Hide</span>
                {% else %}
                <span>Show</span>
                {% endif %}
                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M5 13l4 4L19 7"></path>
                </svg>
            </a>
        </div>
    </div>
    <div class="overflow-x-auto relative">
        <div class="absolute top-0 right-0 bottom-0 w-32 bg-gradient-to-l from-surface-elevated to-transparent pointer-events-none"></div>
        <table class="w-full text-sm sortable">
            <thead class="bg-surface-base border-b border-border-subtle">
                <tr class="text-left">
                    <th class="px-16 py-12 font-semibold text-text-main">Group</th>
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular" data-type="number">Players</th>
                    {% for boon in squad_boon_columns %}
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular" data-type="number">
                        {{ boon.label }}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in squad_boon_uptimes %}
                <tr class="border-b border-border-subtle hover:bg-surface-base transition-colors">
                    <td class="px-16 py-12 text-text-main font-semibold">{{ row.label }}</td>
                    <td class="px-16 py-12 text-right text-text-main font-tabular">{{ row.player_count }}</td>
                    {% for boon in squad_boon_columns %}
                    {% set value = row.boons[boon.key] %}
                    <td class="px-16 py-12 text-right font-tabular {% if value >= 90 %}text-status-success{% elif value >= 50 %}text-status-warning{% else %}text-text-muted{% endif %}">
                        {{ '{:.0f}'.format(value) }}%
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% if show_boon_columns %}
<div class="bg-surface-elevated border border-border-subtle rounded overflow-hidden mb-32">
    <div class="p-24 border-b border-border-subtle">
        <h2 class="text-lg font-bold text-text-main">Detailed Boon Generation</h2>
        <p class="text-sm text-text-muted">Per-player outgoing boon duration (seconds)</p>
    </div>
    <div class="overflow-x-auto relative">
        <div class="absolute top-0 right-0 bottom-0 w-32 bg-gradient-to-l from-surface-elevated to-transparent pointer-events-none"></div>
        <table class="w-full text-sm sortable">
            <thead class="bg-surface-base border-b border-border-subtle">
                <tr class="text-left">
                    <th class="px-16 py-12 font-semibold text-text-main">Character</th>
                    <th class="px-16 py-12 font-semibold text-text-main">Account</th>
                    <th class="px-16 py-12 font-semibold text-text-main">Class</th>
                    <th class="px-16 py-12 font-semibold text-text-main">Role</th>
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular" data-type="number">Group</th>
                    {% for column in boon_generation_columns %}
                    {% set sort = boon_sort_links[column.key] %}
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular" data-type="number">
                        <a href="{{ sort.url }}" class="inline-flex items-center gap-8 justify-end hover:text-text-main">
                            {{ column.label }}
                            <svg class="w-16 h-16 {% if sort.active %}text-gw2-gold{% else %}text-text-muted{% endif %}"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                {% if sort.active and sort.direction == 'desc' %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                {% else %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                {% endif %}
                            </svg>
                        </a>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for player in boon_players %}
                <tr class="border-b border-border-subtle hover:bg-surface-base transition-colors">
                    <td class="px-16 py-12 text-text-main">{{ player.character_name }}</td>
                    <td class="px-16 py-12 text-text-muted text-xs">{{ player.account_name }}</td>
                    <td class="px-16 py-12 text-text-main text-sm">{{ player.spec_name or player.profession or 'Unknown' }}</td>
                    <td class="px-16 py-12">
                        <span class="inline-block px-8 py-4 rounded text-xs font-semibold
                            {% if player.detected_role == 'Pure DPS' %}bg-status-error bg-opacity-20 text-status-error
                            {% elif player.detected_role == 'Strip DPS' %}bg-orange-500 bg-opacity-20 text-orange-400
                            {% elif player.detected_role == 'Boon Support' %}bg-blue-500 bg-opacity-20 text-blue-400
                            {% elif player.detected_role == 'Stab Support' %}bg-cyan-500 bg-opacity-20 text-cyan-400
                            {% elif player.detected_role == 'Healer' %}bg-status-success bg-opacity-20 text-status-success
                            {% else %}bg-text-muted bg-opacity-20 text-text-muted
                            {% endif %}">
                            {{ player.detected_role or 'Unknown' }}
                        </span>
                    </td>
                    <td class="px-16 py-12 text-right font-tabular text-text-muted">
                        {{ player.subgroup or 'â€”' }}
                    </td>
                    {% for column in boon_generation_columns %}
                    {% set display_attr = column.display_attr if column.display_attr is defined else column.attr %}
                    {% set boon_seconds = player|attr(display_attr) %}
                    <td class="px-16 py-12 text-right font-tabular {% if boon_seconds and boon_seconds > 0 %}text-text-main{% else %}text-text-muted{% endif %}">
                        {{ '{:,.1f}'.format((boon_seconds or 0)) }}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endif %}

{% if fight.player_stats %}
<div class="bg-surface-elevated border border-border-subtle rounded overflow-hidden mb-32">
    <div class="p-24 border-b border-border-subtle flex flex-wrap items-center justify-between gap-12">
        <h2 class="text-lg font-bold text-text-main">Allied Players</h2>
    </div>
    <div class="overflow-x-auto relative">
        <div class="absolute top-0 right-0 bottom-0 w-32 bg-gradient-to-l from-surface-elevated to-transparent pointer-events-none"></div>
        <table class="w-full text-sm sortable">
            <thead class="bg-surface-base border-b border-border-subtle">
                <tr class="text-left">
                    <th class="px-16 py-12 font-semibold text-text-main">Character</th>
                    <th class="px-16 py-12 font-semibold text-text-main">Account</th>
                    <th class="px-16 py-12 font-semibold text-text-main">Class</th>
                    <th class="px-16 py-12 font-semibold text-text-main">Role</th>
                    {% for column in allied_numeric_columns %}
                    {% set sort = allied_sort_links[column.key] %}
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular {% if column.key == 'cleanses' %}font-mono whitespace-nowrap{% endif %}" data-type="number">
                        <a href="{{ sort.url }}" class="inline-flex items-center gap-8 justify-end hover:text-text-main">
                            {{ column.label }}
                            <svg class="w-16 h-16 {% if sort.active %}text-gw2-gold{% else %}text-text-muted{% endif %}"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                {% if sort.active and sort.direction == 'desc' %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                {% else %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                {% endif %}
                            </svg>
                        </a>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for player in allied_players %}
                <tr class="border-b border-border-subtle hover:bg-surface-base transition-colors">
                    <td class="px-16 py-12 text-text-main">{{ player.character_name }}</td>
                    <td class="px-16 py-12 text-text-muted text-xs">{{ player.account_name }}</td>
                    <td class="px-16 py-12 text-text-main text-sm">{{ player.spec_name or player.profession or 'Unknown' }}</td>
                    <td class="px-16 py-12">
                        <span class="inline-block px-8 py-4 rounded text-xs font-semibold
                            {% if player.detected_role == 'Pure DPS' %}bg-status-error bg-opacity-20 text-status-error
                            {% elif player.detected_role == 'Strip DPS' %}bg-orange-500 bg-opacity-20 text-orange-400
                            {% elif player.detected_role == 'Boon Support' %}bg-blue-500 bg-opacity-20 text-blue-400
                            {% elif player.detected_role == 'Stab Support' %}bg-cyan-500 bg-opacity-20 text-cyan-400
                            {% elif player.detected_role == 'Healer' %}bg-status-success bg-opacity-20 text-status-success
                            {% else %}bg-text-muted bg-opacity-20 text-text-muted
                            {% endif %}">
                            {{ player.detected_role or 'Unknown' }}
                        </span>
                    </td>
                    <td class="px-16 py-12 text-right text-gw2-gold font-bold font-tabular">
                        {{ '{:,.0f}'.format(player.dps) }}
                    </td>
                    <td class="px-16 py-12 text-right text-text-main font-tabular">
                        {{ '{:,.0f}'.format(player.total_damage) }}
                    </td>
                    <td class="px-16 py-12 text-right text-text-main font-tabular">{{ player.downs }}</td>
                    <td class="px-16 py-12 text-right text-text-main font-tabular">{{ player.kills }}</td>
                    <td class="px-16 py-12 text-right {% if player.deaths > 0 %}text-status-error{% else %}text-text-main{% endif %} font-tabular">
                        {{ player.deaths }}
                    </td>
                    <td class="px-16 py-12 text-right text-text-muted font-tabular">
                        {{ '{:,.0f}'.format(player.damage_taken) }}
                    </td>
                    <td class="px-16 py-12 text-right font-tabular {% if player.strips_out >= 50 %}text-status-success{% elif player.strips_out >= 20 %}text-status-warning{% else %}text-text-muted{% endif %}">
                        {{ player.strips_out }}
                    </td>
                    <td class="px-16 py-12 text-right font-tabular font-mono whitespace-nowrap {% if player.cleanses >= 50 %}text-status-success{% elif player.cleanses >= 20 %}text-status-warning{% else %}text-text-muted{% endif %}">
                        {{ '{:,.0f}'.format(player.cleanses) }}
                    </td>
                    <td class="px-16 py-12 text-right font-tabular {% if player.cc_total >= 1000 %}text-status-success{% elif player.cc_total >= 500 %}text-status-warning{% else %}text-text-muted{% endif %}">
                        {{ '{:,.0f}'.format(player.cc_total) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Enemy Players Section -->
{% set enemy_players = fight.player_stats | rejectattr('account_name') | list %}
{% if enemy_players %}
<div class="bg-surface-elevated border border-border-subtle rounded overflow-hidden">
    <div class="p-24 border-b border-border-subtle">
        <h2 class="text-lg font-bold text-text-main">Enemy Players</h2>
    </div>
    <div class="overflow-x-auto relative">
        <div class="absolute top-0 right-0 bottom-0 w-32 bg-gradient-to-l from-surface-elevated to-transparent pointer-events-none"></div>
        <table class="w-full text-sm sortable">
            <thead class="bg-surface-base border-b border-border-subtle">
                <tr class="text-left">
                    <th class="px-16 py-12 font-semibold text-text-main cursor-pointer hover:bg-surface-elevated transition-colors">
                        <div class="inline-flex items-center gap-8">
                            Character/Profession
                            <svg class="w-16 h-16 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </div>
                    </th>
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular cursor-pointer hover:bg-surface-elevated transition-colors" data-type="number">
                        <div class="inline-flex items-center gap-8 justify-end">
                            DPS
                            <svg class="w-16 h-16 text-gw2-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </th>
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular cursor-pointer hover:bg-surface-elevated transition-colors" data-type="number">
                        <div class="inline-flex items-center gap-8 justify-end">
                            Damage
                            <svg class="w-16 h-16 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </div>
                    </th>
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular cursor-pointer hover:bg-surface-elevated transition-colors" data-type="number">
                        <div class="inline-flex items-center gap-8 justify-end">
                            Downs
                            <svg class="w-16 h-16 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </div>
                    </th>
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular cursor-pointer hover:bg-surface-elevated transition-colors" data-type="number">
                        <div class="inline-flex items-center gap-8 justify-end">
                            Kills
                            <svg class="w-16 h-16 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </div>
                    </th>
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular cursor-pointer hover:bg-surface-elevated transition-colors" data-type="number">
                        <div class="inline-flex items-center gap-8 justify-end">
                            Deaths
                            <svg class="w-16 h-16 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </div>
                    </th>
                    <th class="px-16 py-12 font-semibold text-text-main text-right font-tabular cursor-pointer hover:bg-surface-elevated transition-colors" data-type="number">
                        <div class="inline-flex items-center gap-8 justify-end">
                            Dmg Taken
                            <svg class="w-16 h-16 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for player in enemy_players | sort(attribute='dps', reverse=True) %}
                <tr class="border-b border-border-subtle hover:bg-surface-base transition-colors">
                    <td class="px-16 py-12 text-status-error">{{ player.character_name if player.character_name else 'Unknown' }}</td>
                    <td class="px-16 py-12 text-right text-gw2-gold font-bold font-tabular">
                        {{ '{:,.0f}'.format(player.dps) }}
                    </td>
                    <td class="px-16 py-12 text-right text-text-main font-tabular">
                        {{ '{:,.0f}'.format(player.total_damage) }}
                    </td>
                    <td class="px-16 py-12 text-right text-text-main font-tabular">{{ player.downs }}</td>
                    <td class="px-16 py-12 text-right text-text-main font-tabular">{{ player.kills }}</td>
                    <td class="px-16 py-12 text-right {% if player.deaths > 0 %}text-status-error{% else %}text-text-main{% endif %} font-tabular">
                        {{ player.deaths }}
                    </td>
                    <td class="px-16 py-12 text-right text-text-muted font-tabular">
                        {{ '{:,.0f}'.format(player.damage_taken) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% else %}
<div class="bg-surface-elevated border border-border-subtle rounded p-32 text-center">
    <svg class="w-48 h-48 mx-auto mb-16 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
    </svg>
    <h2 class="text-lg font-bold text-text-main mb-8">No Player Stats Available</h2>
    <p class="text-sm text-text-muted">
        This fight was uploaded before player stats extraction was implemented.
    </p>
</div>
{% endif %}
{% endblock %}
